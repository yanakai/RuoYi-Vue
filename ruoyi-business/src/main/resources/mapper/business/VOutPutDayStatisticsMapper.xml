<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.business.statisticsAlarm.mapper.VOutPutDayStatisticsMapper">
    
    <resultMap type="VOutPutDayStatistics" id="VOutPutDayStatisticsResult">
        <result property="entName"    column="ent_name"    />
        <result property="entCode"    column="ent_code"    />
        <result property="outPutCode"    column="out_put_code"    />
        <result property="outPutName"    column="out_put_name"    />
        <result property="monitorTime"    column="monitor_time"    />
        <result property="outPutType"    column="out_put_type"    />
        <result property="monitoringPointType"    column="monitoring_point_type"    />
        <result property="pollutantNameCn"    column="pollutant_name_cn"    />
        <result property="emissions"    column="emissions"    />
        <result property="alarm"    column="alarm"    />
    </resultMap>

    <resultMap type="com.ruoyi.business.statisticsAlarm.dto.AlarmEmissionsDto" id="AlarmExceptionDtoResult">
        <result property="entName"    column="ent_name"    />
        <result property="entCode"    column="ent_code"    />
        <result property="outPutCode"    column="out_put_code"    />
        <result property="outPutName"    column="out_put_name"    />
        <result property="outPutType"    column="out_put_type"    />
        <result property="monitoringPointType"    column="monitoring_point_type"    />
        <result property="pollutantNameCn"    column="pollutant_name_cn"    />
        <result property="emissions"    column="emissions"    />
        <result property="annualLimitValue"    column="annual_Limit_Value"    />
        <result property="monthlyLimitValue"    column="monthly_limit_value"    />
    </resultMap>

    <sql id="selectVOutPutDayStatisticsVo">
        select ent_name, ent_code, out_put_code, out_put_name, monitor_time, out_put_type, monitoring_point_type, pollutant_name_cn, emissions, alarm from v_out_put_day_statistics
    </sql>

    <select id="selectVOutPutDayStatisticsList" parameterType="VOutPutDayStatistics" resultMap="VOutPutDayStatisticsResult">
        <include refid="selectVOutPutDayStatisticsVo"/>
        <where>  
            <if test="entName != null  and entName != ''"> and ent_name like concat('%', #{entName}, '%')</if>
            <if test="entCode != null  and entCode != ''"> and ent_code = #{entCode}</if>
            <if test="outPutCode != null  and outPutCode != ''"> and out_put_code = #{outPutCode}</if>
            <if test="outPutName != null  and outPutName != ''"> and out_put_name like concat('%', #{outPutName}, '%')</if>
            <if test="monitorTime != null "> and monitor_time = #{monitorTime}</if>
            <if test="outPutType != null  and outPutType != ''"> and out_put_type = #{outPutType}</if>
            <if test="monitoringPointType != null  and monitoringPointType != ''"> and monitoring_point_type = #{monitoringPointType}</if>
            <if test="pollutantNameCn != null  and pollutantNameCn != ''"> and pollutant_name_cn = #{pollutantNameCn}</if>
            <if test="emissions != null  and emissions != ''"> and emissions = #{emissions}</if>
            <if test="alarm != null  and alarm != ''"> and alarm = #{alarm}</if>
        </where>
    </select>

    <select id="selectAlarmExceptionDtoList" parameterType="VOutPutDayStatistics" resultMap="AlarmExceptionDtoResult">
        select  tmp.ent_name,tmp.ent_code, tmp.out_put_code, tmp.out_put_name, tmp.out_put_type, tmp.monitoring_point_type, tmp.pollutant_name_cn, tmp.monitoring_point_type, tmp.pollutant_name_cn,tmp.emissions,gp.annual_limit_value,gp.monthly_limit_value from (
        select ent_code,ent_name,out_put_code,out_put_name,out_put_type,monitoring_point_type, pollutant_name_cn,SUM(emissions) emissions from v_out_put_day_statistics
<!--        where monitor_time>='2024-01-01 00:00:00' and monitor_time<='2024-10-01 00:00:00'-->
        <where>
            <if test="outPutCode != null  and outPutCode != ''">and out_put_code = #{outPutCode}</if>
            <if test="outPutName != null  and outPutName != ''">and out_put_name like concat('%', #{outPutName}, '%')</if>
            <if test="outPutType != null  and outPutType != ''"> and out_put_type = #{outPutType}</if>
            <if test="monitoringPointType != null  and monitoringPointType != ''"> and monitoring_point_type = #{monitoringPointType}</if>
            <choose>
                <when test="params.beginTime != null and params.beginTime != ''">
                    and date_format(monitor_time,'%y%m%d %H:%i:%s') &gt;= date_format(#{params.beginTime},'%y%m%d %H:%i:%s')
                </when>
                <otherwise>
                    and date_format(monitor_time,'%y%m%d %H:%i:%s') &gt;= date_format(now(),'%y%m%d')
                </otherwise>
            </choose>
            <choose>
                <when test="params.endTime != null and params.endTime != ''">
                    and date_format(monitor_time,'%y%m%d %H:%i:%s') &lt;= date_format(#{params.endTime},'%y%m%d %H:%i:%s')
                </when>
                <otherwise>
                    and date_format(monitor_time,'%y%m%d %H:%i:%s') &lt;= date_format(adddate(now(),1),'%y%m%d')
                </otherwise>
            </choose>
        </where>
        GROUP BY ent_code,ent_name,out_put_code,out_put_name,out_put_type,monitoring_point_type,pollutant_name_cn) tmp LEFT JOIN v_out_put_info_pollutant gp on gp.ent_code = tmp.ent_code and gp.out_put_code = tmp.out_put_code and gp.pollutant_name_cn = tmp.pollutant_name_cn
    </select>
</mapper>